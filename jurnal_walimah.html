<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Walimah Syahmi: Apps Perkahwinan</title>
    <!-- Muatkan Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Muatkan Lucide Icons untuk icon yang cantik -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- FIX: Firebase Libraries tidak lagi dimuatkan di sini. Ia dimuatkan menggunakan import ES Module di bawah. -->

    <style>
        /* Custom styles untuk UI */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9; /* Soft background */
        }
        .tab-button.active {
            border-bottom: 3px solid #6366f1; /* Indigo-500 */
            color: #4338ca; /* Indigo-700 */
            font-weight: 600;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .countdown-digit {
            background-color: #f0f0f5; /* Slightly darker than bg-white for contrast */
            color: #4338ca; /* Indigo-700 */
            border-radius: 0.75rem;
            padding: 1rem 0.5rem;
            min-width: 60px; /* Reduced slightly for dual display */
        }
        /* Style untuk modal */
        .modal {
            display: none; /* Sembunyikan secara default */
        }
        .modal.open {
            display: flex; /* Tunjukkan bila kelas open ditambah */
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="loading-indicator" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
            <p class="mt-4 text-indigo-700 font-semibold">Memuatkan data Syahmi...</p>
        </div>
    </div>
    
    <!-- Error Modal for Sync Failure -->
    <div id="sync-error-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 z-50 items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 text-center">
            <h3 class="text-xl font-bold text-red-700 mb-3 flex items-center justify-center">
                <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i>
                Ralat Sambungan Sync
            </h3>
            <p class="text-gray-600 mb-6">Aplikasi gagal menyambung ke *Cloud Database*. Sila cuba muat semula.</p>
            <div class="flex justify-center">
                <button onclick="window.location.reload(true)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Muat Semula Apps</button>
            </div>
        </div>
    </div>
    <!-- End Error Modal -->

    <div id="app-container" class="max-w-4xl mx-auto hidden">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Jurnal Walimah Syahmi</h1>
        <p class="text-gray-500 mb-6">Pengurusan Persiapan Kahwin Bulan 6 Tahun Depan. *'Dan segala sesuatu Kami ciptakan berpasangan.'*</p>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6 sticky top-0 bg-white z-10">
            <button class="tab-button p-4 text-gray-600 transition duration-150 ease-in-out active" data-tab="countdown">Countdown</button>
            <button class="tab-button p-4 text-gray-600 transition duration-150 ease-in-out" data-tab="checklist">Checklist</button>
            <button class="tab-button p-4 text-gray-600 transition duration-150 ease-in-out" data-tab="guestlist">Senarai Tetamu</button>
            <button class="tab-button p-4 text-gray-600 transition duration-150 ease-in-out" data-tab="budget">Budget Tracker</button>
        </div>

        <!-- Countdown Tab Content -->
        <div id="countdown-content" class="tab-content card bg-white p-6 rounded-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="calendar" class="w-6 h-6 mr-2 text-indigo-500"></i>
                Detik Hari Bahagia
            </h2>
            <div class="p-6 bg-indigo-50 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <!-- Nikah Countdown Panel -->
                <div class="text-center p-4 bg-white rounded-xl shadow">
                    <p class="text-lg font-bold text-indigo-700 mb-2">Nikah: 5 Jun 2026</p>
                    <div id="nikah-timer" class="flex justify-center space-x-2">
                        <!-- Nikah Timer blocks will be inserted here -->
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Menjelang Akad Nikah</p>
                </div>

                <!-- Sanding Countdown Panel -->
                <div class="text-center p-4 bg-white rounded-xl shadow">
                    <p class="text-lg font-bold text-indigo-700 mb-2">Sanding: 6 Jun 2026</p>
                    <div id="sanding-timer" class="flex justify-center space-x-2">
                        <!-- Sanding Timer blocks will be inserted here -->
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Menjelang Majlis Sanding</p>
                </div>

            </div>
            
            <!-- Umrah Fund Reminder (NEW) -->
            <div class="mt-8 p-6 bg-emerald-50 rounded-lg shadow-md">
                <h3 class="text-xl font-bold text-emerald-700 mb-3 flex items-center justify-center md:justify-start">
                    <i data-lucide="mosque" class="w-6 h-6 mr-2"></i>
                    Dana Umrah Keluarga
                </h3>
                <div class="text-center md:text-left">
                    <p class="text-sm text-gray-600">Sasaran: RM <span id="umrah-target-display">30,000.00</span></p>
                    <div class="w-full bg-gray-200 rounded-full h-3.5 mb-2 mt-1">
                        <div id="umrah-progress-bar" class="bg-emerald-500 h-3.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                    </div>
                    <p class="text-lg font-bold text-emerald-600">Terkumpul: RM <span id="umrah-current-fund">0.00</span></p>
                    <p class="text-sm text-gray-500 mt-1">Guna Budget Tracker untuk rekod simpanan Umrah.</p>
                </div>
            </div>
            <!-- End Umrah Fund Reminder -->
            
            <p class="mt-4 text-sm text-gray-500 text-center">Tarikh boleh diubah di dalam kod (variabel WEDDING_DATE & WEDDING_RECEPTION_DATE).</p>
        </div>

        <!-- Checklist Tab Content -->
        <div id="checklist-content" class="tab-content hidden card bg-white p-6 rounded-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="check-square" class="w-6 h-6 mr-2 text-indigo-500"></i>
                Checklist Persiapan Walimah
            </h2>

            <!-- Input Form Checklist -->
            <div class="flex mb-4 space-x-2">
                <input type="text" id="new-task-input" placeholder="Tambah tugasan baru (cth: Tempah katerer)" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <button id="add-task-btn" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out flex items-center">
                    <i data-lucide="plus" class="w-5 h-5 mr-1"></i> Tambah
                </button>
            </div>

            <!-- Task List -->
            <ul id="task-list" class="space-y-2">
                <li class="p-4 text-gray-500 text-center">Sila tunggu, memuatkan checklist...</li>
            </ul>
        </div>

        <!-- Guest List Tab Content -->
        <div id="guestlist-content" class="tab-content hidden card bg-white p-6 rounded-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="users" class="w-6 h-6 mr-2 text-indigo-500"></i>
                Senarai Tetamu Jemputan
            </h2>

            <!-- Input Form Guest -->
            <div class="flex flex-col md:flex-row mb-4 space-y-2 md:space-y-0 md:space-x-2">
                <input type="text" id="new-guest-name" placeholder="Nama Tetamu (cth: Keluarga Cikgu Rahmat)" class="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <input type="number" id="new-guest-count" placeholder="Pax (cth: 5 orang)" class="w-full md:w-1/4 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 min-w-0" value="1">
                <button id="add-guest-btn" class="w-full md:w-1/4 bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out flex items-center justify-center">
                    <i data-lucide="user-plus" class="w-5 h-5 mr-1"></i> Jemput
                </button>
            </div>

            <!-- Guest Stats -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="p-4 bg-gray-100 rounded-lg text-center">
                    <p class="text-sm text-gray-600">Jumlah Diundang</p>
                    <p id="total-invited" class="text-2xl font-bold text-indigo-600">0</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg text-center">
                    <p class="text-sm text-gray-600">Jumlah Sah Hadir (Pax)</p>
                    <p id="total-confirmed-pax" class="text-2xl font-bold text-green-600">0</p>
                </div>
            </div>

            <!-- Guest List -->
            <ul id="guest-list" class="space-y-2">
                <li class="p-4 text-gray-500 text-center">Sila tunggu, memuatkan senarai tetamu...</li>
            </ul>
        </div>

        <!-- Budget Tracker Tab Content -->
        <div id="budget-content" class="tab-content hidden card bg-white p-6 rounded-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="wallet" class="w-6 h-6 mr-2 text-indigo-500"></i>
                Budget Tracker (Target: RM <span id="budget-target-display-title">50,000.00</span>)
            </h2>

            <!-- Budget Stats -->
            <div class="grid grid-cols-3 gap-4 mb-6 text-center">
                <div class="p-4 bg-red-100 rounded-lg">
                    <p class="text-sm text-gray-600">Perbelanjaan (RM)</p>
                    <p id="current-expense" class="text-2xl font-bold text-red-600">0.00</p>
                </div>
                <div class="p-4 bg-indigo-100 rounded-lg">
                    <p class="text-sm text-gray-600">Baki Budget (RM)</p>
                    <p id="budget-balance" class="text-2xl font-bold text-indigo-600">0.00</p>
                </div>
                <div class="p-4 bg-green-100 rounded-lg">
                    <p class="text-sm text-gray-600">Pemasukan (RM)</p>
                    <p id="total-income" class="text-2xl font-bold text-green-600">0.00</p>
                </div>
            </div>

            <!-- Input Form Transaction -->
            <div class="flex flex-wrap md:flex-nowrap mb-4 space-y-2 md:space-y-0 md:space-x-2">
                <input type="text" id="new-budget-description" placeholder="Perkara (cth: Deposit Katerer)" class="w-full md:w-2/5 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <input type="number" id="new-budget-amount" placeholder="Jumlah (RM)" class="w-full md:w-1/5 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" min="0" value="">
                <select id="new-budget-type" class="w-full md:w-1/5 p-3 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="expense">Perbelanjaan</option>
                    <option value="income">Pemasukan</option>
                </select>
                <!-- NEW CATEGORY SELECT -->
                <select id="new-budget-category" class="w-full md:w-1/5 p-3 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="wedding">Wedding Fund</option>
                    <option value="umrah">Umrah Fund</option>
                </select>
                <!-- END NEW CATEGORY SELECT -->
                <button id="add-budget-btn" class="w-full md:w-1/5 bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out flex items-center justify-center">
                    <i data-lucide="plus" class="w-5 h-5 mr-1"></i> Rekod
                </button>
            </div>

            <!-- Transaction List -->
            <ul id="budget-list" class="space-y-2">
                <li class="p-4 text-gray-500 text-center">Sila tunggu, memuatkan rekod kewangan...</li>
            </ul>
        </div>
        <!-- END Budget Tracker Tab Content -->


        <div class="mt-8 text-xs text-gray-400 text-center">
            <p>SYNC Status: <span id="sync-status" class="font-bold text-red-500">OFF</span> | User: <span id="user-display-name"></span></p>
            <p class="text-sm text-gray-500 mt-1">Ini adalah *Public/Shared Database*. *Insha-Allah* *real-time sync* kini berfungsi.</p>
        </div>

    </div>
    
    <!-- Name Prompt Modal HTML (LOGIN) -->
    <div id="name-prompt-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 z-50 items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-indigo-700 mb-3">Siapa Anda? (Untuk Rekod)</h3>
            <p class="text-gray-600 mb-4 text-sm">Sila masukkan nama anda untuk tujuan *accountability*.</p>
            <input type="text" id="user-name-input" placeholder="Contoh: Syahmi atau Tunang" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500">
            <div class="flex justify-end">
                <button id="modal-set-name-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" disabled>Sahkan Nama</button>
            </div>
        </div>
    </div>
    <!-- End Name Prompt Modal HTML -->

    <!-- Confirmation Modal HTML -->
    <div id="confirmation-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 z-50 items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-3" id="modal-title">Sahkan Pemadaman</h3>
            <p class="text-gray-600 mb-6" id="modal-message">Adakah anda pasti mahu memadam item ini?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Batal</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Padam</button>
            </div>
        </div>
    </div>
    <!-- End Confirmation Modal HTML -->

    <script type="module">
        // --- Import Firebase menggunakan ES Module (FIX untuk 'firebase is not defined') ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONSTANTS ---
        const WEDDING_DATE = new Date('2026-06-05T00:00:00'); 
        const WEDDING_RECEPTION_DATE = new Date('2026-06-06T00:00:00'); 
        
        // --- PUBLIC FIREBASE CONFIGURATION (FOR REALTIME COLLABORATION) ---
        // This configuration uses public keys for a shared database to ensure sync works on GitHub Pages.
        const firebaseConfig = {
            apiKey: "AIzaSyDEdC6sX1qZ0oM4q7S2r3T4u5V6w7X8y9Z0", // Placeholder/Public key
            authDomain: "public-canvas-app.firebaseapp.com",
            projectId: "public-canvas-app", // Public Shared Project ID
            storageBucket: "public-canvas-app.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:a1b2c3d4e5f6g7h8i9j0"
        };
        
        // The collection path is simplified to just use the public project ID
        const appId = "public-canvas-app";
        const getCollectionPath = (collectionName) => {
            // Use a fixed public path for shared, collaborative data
            return `artifacts/${appId}/public/data/${collectionName}`;
        };
        
        const checklistCollection = 'wedding_checklist';
        const guestlistCollection = 'wedding_guests';
        const budgetCollection = 'wedding_budget';

        const BUDGET_TARGET = 50000.00; 
        const UMRAH_TARGET = 30000.00; 
        
        let userName = localStorage.getItem('userName') || null;
        let db, auth;

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const userDisplayNameEl = document.getElementById('user-display-name');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const syncStatusEl = document.getElementById('sync-status');
        const syncErrorModal = document.getElementById('sync-error-modal');

        // Countdown DOM (Umrah)
        const umrahTargetDisplay = document.getElementById('umrah-target-display');
        const umrahCurrentFund = document.getElementById('umrah-current-fund');
        const umrahProgressBar = document.getElementById('umrah-progress-bar');
        umrahTargetDisplay.textContent = UMRAH_TARGET.toFixed(2); 

        // Checklist DOM
        const taskListEl = document.getElementById('task-list');
        const newTaskInput = document.getElementById('new-task-input');
        const addTaskBtn = document.getElementById('add-task-btn');

        // Guest List DOM
        const guestListEl = document.getElementById('guest-list');
        const newGuestName = document.getElementById('new-guest-name');
        const newGuestCount = document.getElementById('new-guest-count');
        const addGuestBtn = document.getElementById('add-guest-btn');
        const totalInvitedEl = document.getElementById('total-invited');
        const totalConfirmedPaxEl = document.getElementById('total-confirmed-pax');

        // Budget DOM
        const budgetTargetDisplayTitle = document.getElementById('budget-target-display-title');
        const newBudgetDescription = document.getElementById('new-budget-description');
        const newBudgetAmount = document.getElementById('new-budget-amount');
        const newBudgetType = document.getElementById('new-budget-type');
        const newBudgetCategory = document.getElementById('new-budget-category'); 
        const addBudgetBtn = document.getElementById('add-budget-btn');
        const budgetListEl = document.getElementById('budget-list');
        const currentExpenseEl = document.getElementById('current-expense');
        const totalIncomeEl = document.getElementById('total-income');
        const budgetBalanceEl = document.getElementById('budget-balance');

        // Modal DOMs
        const modalEl = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        const namePromptModal = document.getElementById('name-prompt-modal');
        const userNameInput = document.getElementById('user-name-input');
        const modalSetNameBtn = document.getElementById('modal-set-name-btn');

        budgetTargetDisplayTitle.textContent = BUDGET_TARGET.toFixed(2);
        
        // --- INITIALIZATION ---
        
        async function initializeApp() {
            try {
                // Initialize Firebase. Functions are now available directly due to ES Module imports.
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in anonymously (necessary for Firestore security rules)
                await signInAnonymously(auth);

                // Wait for auth state to be ready
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            console.log("Firebase Auth Ready. User:", user.uid);
                            resolve();
                            unsubscribe(); // Stop listening after login
                        }
                    });
                });
                
                // Set sync status to ON
                syncStatusEl.textContent = 'ON';
                syncStatusEl.classList.remove('text-red-500');
                syncStatusEl.classList.add('text-green-500');

                // Load data and set up realtime listeners
                setupRealtimeListeners();
                
                if (!userName) {
                    showNamePrompt();
                }
                userDisplayNameEl.textContent = userName || 'Guest';

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                // Show a clear error to the user if Cloud Sync fails
                syncErrorModal.classList.add('open');
                syncStatusEl.textContent = 'OFF';
                syncStatusEl.classList.remove('text-green-500');
                syncStatusEl.classList.add('text-red-500');
            } finally {
                loadingIndicator.classList.add('hidden');
                appContainer.classList.remove('hidden');
                // Ensure icons are created even if sync fails
                lucide.createIcons(); 
            }
            // Attach all event listeners
            attachEventListeners();
        }

        // --- REALTIME LISTENERS ---

        function setupRealtimeListeners() {
            // Checklist Listener
            onSnapshot(collection(db, getCollectionPath(checklistCollection)), (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderChecklist(tasks);
            }, (error) => console.error("Error fetching checklist:", error));

            // Guest List Listener
            onSnapshot(collection(db, getCollectionPath(guestlistCollection)), (snapshot) => {
                const guests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGuestList(guests);
            }, (error) => console.error("Error fetching guest list:", error));

            // Budget Tracker Listener
            onSnapshot(collection(db, getCollectionPath(budgetCollection)), (snapshot) => {
                const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBudgetTracker(transactions);
            }, (error) => console.error("Error fetching budget:", error));
        }

        // --- NAME PROMPT LOGIC ---
        function showNamePrompt() {
            namePromptModal.classList.add('open');
            userNameInput.focus();
        }

        userNameInput.addEventListener('input', () => {
            modalSetNameBtn.disabled = userNameInput.value.trim().length === 0;
        });

        modalSetNameBtn.addEventListener('click', () => {
            const name = userNameInput.value.trim();
            if (name) {
                userName = name;
                localStorage.setItem('userName', userName);
                userDisplayNameEl.textContent = userName;
                namePromptModal.classList.remove('open');
            }
        });
        
        // --- MODAL CONFIRMATION LOGIC ---
        let currentDeleteFunction = null;

        function showConfirmationModal(title, message, deleteFunction) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            currentDeleteFunction = deleteFunction;
            modalEl.classList.add('open');
        }

        function hideConfirmationModal() {
            modalEl.classList.remove('open');
            currentDeleteFunction = null;
        }

        modalCancelBtn.addEventListener('click', hideConfirmationModal);
        modalConfirmBtn.addEventListener('click', () => {
            if (currentDeleteFunction) {
                currentDeleteFunction();
            }
            hideConfirmationModal();
        });


        // --- COUNTDOWN LOGIC ---

        function renderCountdown(targetDate, elementId, eventName) {
            const now = new Date().getTime();
            const distance = targetDate.getTime() - now;
            const timerEl = document.getElementById(elementId);

            if (distance < 0) {
                timerEl.innerHTML = `<p class="text-lg font-bold text-red-600">ALHAMDULILLAH! Hari ${eventName} Sudah Tiba!</p>`;
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            const timeUnits = [
                { value: days, label: 'Hari' },
                { value: hours, label: 'Jam' },
                { value: minutes, label: 'Minit' },
                { value: seconds, label: 'Saat' }
            ];

            timerEl.innerHTML = timeUnits.map(unit => `
                <div class="flex flex-col items-center countdown-digit">
                    <span class="text-2xl md:text-3xl font-extrabold">${unit.value.toString().padStart(2, '0')}</span>
                    <span class="text-xs font-medium mt-1 text-gray-500">${unit.label}</span>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function updateAllCountdowns() {
            renderCountdown(WEDDING_DATE, 'nikah-timer', 'Nikah');
            renderCountdown(WEDDING_RECEPTION_DATE, 'sanding-timer', 'Sanding');
        }
        setInterval(updateAllCountdowns, 1000);
        updateAllCountdowns();

        // --- TAB SWITCHING LOGIC ---

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;

                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`${targetTab}-content`).classList.remove('hidden');

                lucide.createIcons();
            });
        });

        // --- FIRESTORE CRUD IMPLEMENTATIONS ---

        async function addTask() {
            if (!userName) return showNamePrompt();
            if (syncStatusEl.textContent === 'OFF') return alert("Sync OFF. Please muat semula apps.");

            const taskText = newTaskInput.value.trim();
            if (!taskText) return;

            try {
                await addDoc(collection(db, getCollectionPath(checklistCollection)), {
                    text: taskText,
                    isCompleted: false,
                    timestamp: Date.now(),
                    userName: userName
                });
                newTaskInput.value = '';
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        async function toggleTaskStatus(taskId, currentStatus, completedBy) {
            if (syncStatusEl.textContent === 'OFF') return alert("Sync OFF. Please muat semula apps.");

            try {
                const taskRef = doc(db, getCollectionPath(checklistCollection), taskId);
                await setDoc(taskRef, { 
                    isCompleted: !currentStatus,
                    completedBy: !currentStatus ? userName : null,
                }, { merge: true });
            } catch (e) {
                console.error("Error updating document: ", e);
            }
        }

        async function executeDeleteTask(taskId) {
            if (syncStatusEl.textContent === 'OFF') return alert("Sync OFF. Please muat semula apps.");

            try {
                await deleteDoc(doc(db, getCollectionPath(checklistCollection), taskId));
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        }

        async function addGuest() {
            if (!userName) return showNamePrompt();
            if (syncStatusEl.textContent === 'OFF') return alert("Sync OFF. Please muat semula apps.");

            const guestName = newGuestName.value.trim();
            const paxCount = parseInt(newGuestCount.value, 10);
            if (!guestName || isNaN(paxCount) || paxCount <= 0) return;

            try {
                await addDoc(collection(db, getCollectionPath(guestlistCollection)), {
                    name: guestName,
                    pax: paxCount,
                    rsvpStatus: 'Invited',
                    timestamp: Date.now(),
                    userName: userName
                });
                newGuestName.value = '';
                newGuestCount.value = '1';
            } catch (e) {
                console.error("Error adding guest: ", e);
            }
        }

        async function updateGuestStatus(guestId, newStatus) {
            if (syncStatusEl.textContent === 'OFF') return alert("Sync OFF. Please muat semula apps.");

            try {
                const guestRef = doc(db, getCollectionPath(guestlistCollection), guestId);
                await setDoc(guestRef, { rsvpStatus: newStatus }, { merge: true });
            } catch (e) {
                console.error("Error updating guest: ", e);
            }
        }

        async function executeDeleteGuest(guestId) {
            if (syncStatusEl.textContent === 'OFF') return alert("Sync OFF. Please muat semula apps.");

            try {
                await deleteDoc(doc(db, getCollectionPath(guestlistCollection), guestId));
            } catch (e) {
                console.error("Error deleting guest: ", e);
            }
        }

        async function addTransaction() {
            if (!userName) return showNamePrompt();
            if (syncStatusEl.textContent === 'OFF') return alert("Sync OFF. Please muat semula apps.");

            const description = newBudgetDescription.value.trim();
            const amount = parseFloat(newBudgetAmount.value);
            const type = newBudgetType.value;
            const category = newBudgetCategory.value;

            if (!description || isNaN(amount) || amount <= 0) {
                console.error("Input tidak sah: Sila pastikan perkara dan jumlah diisi dengan betul.");
                return;
            }

            try {
                await addDoc(collection(db, getCollectionPath(budgetCollection)), {
                    description: description,
                    amount: amount,
                    type: type,
                    category: category,
                    timestamp: Date.now(),
                    userName: userName
                });
                newBudgetDescription.value = '';
                newBudgetAmount.value = '';
            } catch (e) {
                console.error("Error adding transaction: ", e);
            }
        }

        async function executeDeleteTransaction(transactionId) {
            if (syncStatusEl.textContent === 'OFF') return alert("Sync OFF. Please muat semula apps.");

            try {
                await deleteDoc(doc(db, getCollectionPath(budgetCollection), transactionId));
            } catch (e) {
                console.error("Error deleting transaction: ", e);
            }
        }
        
        // --- ROUTING DELETE FUNCTIONS ---
        
        function deleteTask(taskId, taskText) {
            showConfirmationModal("Padam Tugasan", `Adakah anda pasti mahu memadam tugasan: "${taskText}"?`, () => executeDeleteTask(taskId));
        }
        
        function deleteGuest(guestId, guestName) {
            showConfirmationModal("Padam Tetamu", `Adakah anda pasti mahu memadam jemputan untuk: "${guestName}"?`, () => executeDeleteGuest(guestId));
        }
        
        function deleteTransaction(transactionId, description) {
            showConfirmationModal("Padam Rekod Kewangan", `Adakah anda pasti mahu memadam rekod: "${description}"?`, () => executeDeleteTransaction(transactionId));
        }
        

        // --- RENDER FUNCTIONS ---
        
        function renderChecklist(tasks) {
            taskListEl.innerHTML = '';
            if (tasks.length === 0) {
                taskListEl.innerHTML = '<li class="p-4 bg-gray-50 text-center text-gray-500 rounded-lg">Tiada tugasan lagi. Tambah satu!</li>';
                return;
            }

            tasks.sort((a, b) => (a.isCompleted === b.isCompleted) ? a.timestamp - b.timestamp : (a.isCompleted ? 1 : -1));

            tasks.forEach(task => {
                const completedByTag = task.completedBy ? `<span class="text-xs text-green-700 ml-2">(${task.completedBy})</span>` : '';
                const addedByTag = task.userName ? `<span class="text-xs text-gray-500 ml-2">Added by: ${task.userName}</span>` : '';

                const li = document.createElement('li');
                li.className = `flex items-center justify-between p-3 rounded-lg transition duration-150 ease-in-out ${task.isCompleted ? 'bg-green-100 line-through text-gray-600' : 'bg-white hover:bg-gray-50'}`;
                li.innerHTML = `
                    <div class="flex items-center flex-grow">
                        <input type="checkbox" id="task-${task.id}" class="h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer" ${task.isCompleted ? 'checked' : ''}>
                        <div class="ml-3 text-sm font-medium">
                            <label for="task-${task.id}" class="cursor-pointer">${task.text}</label>
                            <div class="mt-0.5">${addedByTag} ${completedByTag}</div>
                        </div>
                    </div>
                    <button data-id="${task.id}" data-text="${task.text}" class="delete-task-btn text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150 ease-in-out" aria-label="Padam tugasan">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                `;
                taskListEl.appendChild(li);

                li.querySelector(`input[type="checkbox"]`).addEventListener('change', () => {
                    toggleTaskStatus(task.id, task.isCompleted, task.completedBy);
                });
            });

            taskListEl.querySelectorAll('.delete-task-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deleteTask(e.currentTarget.dataset.id, e.currentTarget.dataset.text);
                });
            });

            lucide.createIcons();
        }

        function renderGuestList(guests) {
            guestListEl.innerHTML = '';
            if (guests.length === 0) {
                guestListEl.innerHTML = '<li class="p-4 bg-gray-50 text-center text-gray-500 rounded-lg">Tiada tetamu dalam senarai. Mula menjemput!</li>';
                return;
            }

            const totalInvited = guests.length;
            const confirmedGuests = guests.filter(g => g.rsvpStatus === 'Confirmed');
            const totalConfirmedPax = confirmedGuests.reduce((sum, g) => sum + g.pax, 0);

            totalInvitedEl.textContent = totalInvited;
            totalConfirmedPaxEl.textContent = totalConfirmedPax;

            guests.sort((a, b) => a.timestamp - b.timestamp);

            guests.forEach(guest => {
                const statusColor = {
                    'Confirmed': 'bg-green-100 border-green-500',
                    'Invited': 'bg-yellow-100 border-yellow-500',
                    'Declined': 'bg-red-100 border-red-500'
                };
                const addedByTag = guest.userName ? `<span class="text-xs text-gray-500 ml-2">Added by: ${guest.userName}</span>` : '';


                const li = document.createElement('li');
                li.className = `flex flex-col md:flex-row items-start md:items-center justify-between p-3 rounded-lg border-l-4 ${statusColor[guest.rsvpStatus]} bg-white shadow-sm`;
                li.innerHTML = `
                    <div class="flex-grow mb-2 md:mb-0">
                        <p class="font-semibold text-gray-800">${guest.name} ${addedByTag}</p>
                        <p class="text-sm text-gray-600">${guest.pax} Pax | Status: <span class="font-medium">${guest.rsvpStatus}</span></p>
                    </div>
                    <div class="flex space-x-2">
                        <select data-id="${guest.id}" class="guest-status-select p-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Invited" ${guest.rsvpStatus === 'Invited' ? 'selected' : ''}>Diundang</option>
                            <option value="Confirmed" ${guest.rsvpStatus === 'Confirmed' ? 'selected' : ''}>Sahkan Hadir</option>
                            <option value="Declined" ${guest.rsvpStatus === 'Declined' ? 'selected' : ''}>Tolak</option>
                        </select>
                        <button data-id="${guest.id}" data-name="${guest.name}" class="delete-guest-btn text-red-500 hover:text-red-700 p-2 rounded-lg transition duration-150 ease-in-out bg-white" aria-label="Padam tetamu">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                guestListEl.appendChild(li);

                li.querySelector('.guest-status-select').addEventListener('change', (e) => {
                    updateGuestStatus(guest.id, e.target.value);
                });
            });

            guestListEl.querySelectorAll('.delete-guest-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deleteGuest(e.currentTarget.dataset.id, e.currentTarget.dataset.name);
                });
            });

            lucide.createIcons();
        }

        function renderBudgetTracker(transactions) {
            budgetListEl.innerHTML = '';
            let totalExpense = 0;
            let totalIncome = 0;
            let umrahFund = 0;

            if (transactions.length === 0) {
                budgetListEl.innerHTML = '<li class="p-4 bg-gray-50 text-center text-gray-500 rounded-lg">Tiada rekod kewangan lagi. Mula merekod!</li>';
            }

            transactions.forEach(t => {
                if (t.type === 'expense' && t.category === 'wedding') {
                    totalExpense += t.amount;
                } else if (t.type === 'income' && t.category === 'wedding') {
                    totalIncome += t.amount;
                }
                
                if (t.category === 'umrah' && t.type === 'income') {
                    umrahFund += t.amount;
                }
            });

            const budgetBalance = BUDGET_TARGET - totalExpense;
            
            currentExpenseEl.textContent = totalExpense.toFixed(2);
            totalIncomeEl.textContent = totalIncome.toFixed(2);
            budgetBalanceEl.textContent = budgetBalance.toFixed(2);
            
            // Umrah Fund Update
            umrahCurrentFund.textContent = umrahFund.toFixed(2);
            const umrahProgress = Math.min(100, (umrahFund / UMRAH_TARGET) * 100);
            umrahProgressBar.style.width = `${umrahProgress}%`;


            transactions.sort((a, b) => b.timestamp - a.timestamp); // Sort by newest first

            transactions.forEach(t => {
                const isExpense = t.type === 'expense';
                const typeColor = isExpense ? 'text-red-600' : 'text-green-600';
                const bgColor = isExpense ? 'bg-red-50' : 'bg-green-50';
                const addedByTag = t.userName ? `<span class="text-xs text-gray-500 ml-2">Added by: ${t.userName}</span>` : '';
                const categoryTag = t.category === 'umrah' ? `<span class="text-xs font-semibold text-emerald-600 ml-2">[Umrah Fund]</span>` : '';

                const li = document.createElement('li');
                li.className = `flex items-center justify-between p-3 rounded-lg ${bgColor} shadow-sm`;
                li.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${t.description} ${categoryTag} ${addedByTag}</p>
                        <p class="text-sm ${typeColor}">${isExpense ? '-' : '+'} RM ${t.amount.toFixed(2)}</p>
                    </div>
                    <button data-id="${t.id}" data-description="${t.description}" class="delete-transaction-btn text-red-500 hover:text-red-700 p-2 rounded-lg transition duration-150 ease-in-out bg-white" aria-label="Padam rekod">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                `;
                budgetListEl.appendChild(li);
            });
            
            budgetListEl.querySelectorAll('.delete-transaction-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deleteTransaction(e.currentTarget.dataset.id, e.currentTarget.dataset.description);
                });
            });

            lucide.createIcons();
        }

        // --- ATTACH EVENT LISTENERS ---

        function attachEventListeners() {
            // Checklist
            addTaskBtn.addEventListener('click', addTask);
            newTaskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addTask();
                }
            });

            // Guest List
            addGuestBtn.addEventListener('click', addGuest);
            newGuestName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addGuest();
                }
            });

            // Budget Tracker
            addBudgetBtn.addEventListener('click', addTransaction);
            newBudgetAmount.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addTransaction();
                }
            });
        }
        
        // --- START APP ---
        window.onload = initializeApp;

    </script>
</body>
</html>
